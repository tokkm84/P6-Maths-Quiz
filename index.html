<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSLE Fraction Mastery Quiz (Final Connected)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; padding: 20px; margin: 0; min-height: 100vh; }
        .quiz-container { background: white; width: 100%; max-width: 700px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        h1 { color: #2c3e50; text-align: center; margin: 0 0 10px 0; font-weight: 800; letter-spacing: -0.5px; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 0.95em; margin-bottom: 25px; font-style: italic; }
        
        .progress-bar-bg { width: 100%; background-color: #ecf0f1; height: 10px; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: #3498db; width: 0%; transition: width 0.3s ease; }

        .question-card { background-color: #eaf2f8; padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 6px solid #3498db; position: relative; }
        .cat-tag { position: absolute; top: -12px; left: 20px; background: #34495e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: bold; letter-spacing: 0.5px; }
        .diff-tag { position: absolute; top: -12px; right: 20px; background: #e67e22; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: bold; letter-spacing: 0.5px; display:none; }
        
        .q-text { font-size: 1.35em; color: #2c3e50; margin-top: 15px; font-weight: 600; line-height: 2.2; }

        /* --- VISUAL ENGINES --- */
        .visual-container { background: white; border: 2px solid #e1e8ed; border-radius: 10px; padding: 20px; margin: 15px 0; min-height: 120px; display: flex; align-items: center; justify-content: center; position: relative; flex-direction: column; }
        
        /* Grid */
        .grid-visual { display: grid; gap: 2px; background: #333; border: 2px solid #333; }
        .grid-cell { width: 40px; height: 40px; background: white; }
        .grid-cell.shaded { background: #3498db; }

        /* Set */
        .set-visual { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width: 80%; }
        .set-item { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #333; background: white; }
        .set-item.shaded { background-color: #3498db; }

        /* Pie */
        .pie-visual { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #333; position: relative; }

        /* Number Line */
        .nl-line { position: relative; width: 90%; height: 4px; background: #333; margin: 20px auto; }
        .nl-tick { position: absolute; top: -8px; width: 2px; height: 20px; background: #333; }
        .nl-label { position: absolute; top: 18px; transform: translateX(-50%); font-size: 0.9em; font-weight: bold; color: #555; }
        .nl-point { position: absolute; top: -6px; width: 16px; height: 16px; background: #e74c3c; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: translateX(-50%); z-index: 2; }
        .nl-point-label { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); color: #e74c3c; font-weight: bold; white-space: nowrap; }

        /* Buttons */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { background: white; border: 2px solid #bdc3c7; padding: 10px; border-radius: 10px; font-size: 1.1em; cursor: pointer; transition: 0.2s; color: #34495e; font-weight: 500; display: flex; align-items: center; justify-content: center; min-height: 60px; line-height: 1.5; }
        .option-btn:hover { border-color: #3498db; background-color: #f4fcff; transform: translateY(-2px); }
        .option-btn.correct { background-color: #2ecc71; border-color: #27ae60; color: white; }
        .option-btn.wrong { background-color: #e74c3c; border-color: #c0392b; color: white; }
        
        .feedback { display: none; margin-top: 25px; padding: 20px; background-color: #f8f9fa; border-radius: 10px; border-left: 5px solid #bdc3c7; }
        .feedback.correct { border-left-color: #2ecc71; background-color: #eafaf1; }
        .feedback.wrong { border-left-color: #e74c3c; background-color: #fdedec; }
        
        .next-btn { width: 100%; padding: 18px; background-color: #3498db; color: white; border: none; border-radius: 10px; font-size: 1.2em; margin-top: 20px; cursor: pointer; font-weight: bold; display: none; }
        
        /* New Start Screen Styles */
        #startScreen { text-align: center; padding: 30px 20px; border-radius: 15px; }
        .start-icon { font-size: 4.5em; display: block; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        .input-group { margin-bottom: 20px; text-align: left; max-width: 320px; margin-left: auto; margin-right: auto; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #2c3e50; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input[type="text"], select { width: 100%; padding: 12px 15px; font-size: 1em; border: 2px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; transition: all 0.3s; display: block; margin: 0; text-align: left; color: #2c3e50; background: #fff; }
        input[type="text"]:focus, select:focus { border-color: #3498db; box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1); outline: none; }
        
        .start-btn { width: 100%; max-width: 320px; padding: 16px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 50px; font-size: 1.2em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); transition: transform 0.2s, box-shadow 0.2s; margin-top: 10px; }
        .start-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4); }
        .start-btn:active { transform: translateY(1px); }

        /* Fraction CSS Helpers */
        .frac { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 2px; font-size: 0.85em; position: relative; top: -5px; }
        .frac span.top { border-bottom: 2px solid #333; padding: 0 3px; display: block; width: 100%; text-align: center; }
        .frac span.bottom { padding: 0 3px; display: block; width: 100%; text-align: center; }
        
        /* Mixed Number Helper */
        .mixed { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 5px; white-space: nowrap; }
        .whole { font-size: 1.2em; margin-right: 3px; }

        /* Result Actions */
        .result-card { border: 2px dashed #bdc3c7; padding: 20px; background: #fff; margin-bottom: 20px; border-radius: 10px; }
        .btn-retry { background-color: #95a5a6; color: white; display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; font-weight: bold; }
        
        #submitStatus { font-weight: bold; margin-top: 15px; padding: 10px; border-radius: 5px; background: #f8f9fa; display: none; }
        
        .manual-link { display: inline-block; margin-top: 10px; color: #3498db; text-decoration: none; font-weight: bold; border: 1px solid #3498db; padding: 8px 15px; border-radius: 5px; }
        .manual-link:hover { background: #3498db; color: white; }

    </style>
</head>
<body>

<div class="quiz-container">
    <h1>üìê Fraction Mastery Quiz</h1>
    <p class="subtitle">PSLE Paper 1 Standard (No Calculators)</p>
    
    <div id="startScreen">
        <div class="start-icon">üë®‚Äçüéì</div>
        <p style="color: #7f8c8d; margin-bottom: 25px;">Ready to test your Fraction skills?</p>
        
        <div class="input-group">
            <label for="studentName">Student Name</label>
            <input type="text" id="studentName" placeholder="e.g. John Tan" />
        </div>
        
        <div class="input-group">
            <label for="quizMode">Select Challenge</label>
            <select id="quizMode">
                <option value="topic">üìö Topic by Topic (Best for Learning)</option>
                <option value="mastery">üî• Mastery Mode (Mixed & Random)</option>
            </select>
        </div>
        
        <button class="start-btn" onclick="startQuiz()">Start Quiz üöÄ</button>
    </div>

    <div id="gameUI" style="display:none;">
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        
        <div class="question-card">
            <span class="cat-tag" id="catLabel">TOPIC</span>
            <span class="diff-tag" id="diffLabel">EASY</span>
            <div class="q-text" id="qText">Loading...</div>
            <div id="visualArea" style="display:none;"></div>
        </div>
        
        <div class="options-grid" id="optionsArea"></div>
        <div class="feedback" id="feedbackArea"></div>
        <button class="next-btn" id="nextBtn" onclick="nextQuestion()">Next Question ‚û°</button>
    </div>
</div>

<!-- HIDDEN IFRAME FOR FORM SUBMISSION -->
<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(window.submitted) { document.getElementById('submitStatus').innerHTML = '‚úÖ Results sent automatically!'; document.getElementById('submitStatus').style.color = 'green'; }"></iframe>

<!-- HIDDEN FORM -->
<form action="" method="post" target="hidden_iframe" id="hidden_form" style="display:none;">
    <input type="text" name="" id="form_name">
    <input type="text" name="" id="form_score">
    <input type="text" name="" id="form_mode">
</form>

<script>
    // ============================================
    // üõë TEACHER SETUP COMPLETED üõë
    // ============================================
    
    // 1. Google Form URL
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScG_2QyoXpDzeR54o7uN-MHgfftk-f08vntC5KIEnL2dH4nrQ/formResponse"; 
    
    // 2. Entry IDs
    const ENTRY_IDS = {
        name: "entry.1376623119",
        score: "entry.2032202022",
        mode: "entry.1918358329"
    };
    // ============================================

    // --- DISPLAY HELPERS ---
    const f = (n, d) => `<span class="frac"><span class="top">${n}</span><span class="bottom">${d}</span></span>`;
    const m = (w, n, d) => `<span class="mixed"><span class="whole">${w}</span><span class="frac"><span class="top">${n}</span><span class="bottom">${d}</span></span></span>`;

    // Questions with Difficulty (1=Easy, 2=Medium, 3=Hard)
    const questions = [
        // --- MIXED & IMPROPER ---
        { 
            cat: "Mixed & Improper", diff: 1,
            q: `Q1. Express ${m(4,2,3)} as an improper fraction.`, 
            options: [f(8,3), f(11,3), f(14,3), f(12,3)], 
            correct: 2, 
            exp: `<b>Strategy:</b> (Whole √ó Denominator) + Numerator.<br>4 √ó 3 = 12.<br>12 + 2 = 14.<br>Ans: ${f(14,3)}` 
        },
        { 
            cat: "Mixed & Improper", diff: 1,
            q: `Q2. Express ${f(23,4)} as a mixed number.`, 
            options: [m(5,1,4), m(5,3,4), m(4,3,4), m(6,1,4)], 
            correct: 1, 
            exp: `<b>Strategy:</b> Divide 23 by 4.<br>23 √∑ 4 = 5 with remainder 3.<br>Ans: ${m(5,3,4)}` 
        },
        { 
            cat: "Mixed & Improper", diff: 2,
            q: `Q3. Which mixed number is equal to ${f(30,7)}?`, 
            options: [m(4,2,7), m(3,6,7), m(4,1,7), m(5,2,7)], 
            correct: 0, 
            exp: `<b>Strategy:</b> Multiples of 7: 7, 14, 21, 28.<br>30 - 28 = 2 (remainder).<br>Ans: ${m(4,2,7)}` 
        },

        // --- ADDITION & SUBTRACTION ---
        { 
            cat: "Add & Subtract", diff: 2,
            q: `Q4. Find the value of ${f(1,2)} + ${f(1,4)} + ${f(1,8)}.`, 
            options: [f(3,14), f(7,8), f(5,8), f(3,8)], 
            correct: 1, 
            exp: `<b>Common Denom 8:</b><br>${f(4,8)} + ${f(2,8)} + ${f(1,8)} = ${f(7,8)}` 
        },
        { 
            cat: "Add & Subtract", diff: 3,
            q: `Q5. Find the value of 2 - ${f(1,2)} - ${f(1,4)}.`, 
            options: [m(1,1,4), m(1,1,2), f(3,4), f(5,8)], 
            correct: 0, 
            exp: `<b>Step 1:</b> 2 - ${f(1,2)} = ${m(1,1,2)}.<br><b>Step 2:</b> ${m(1,1,2)} - ${f(1,4)} = ${m(1,2,4)} - ${f(1,4)} = ${m(1,1,4)}.` 
        },

        // --- VISUAL FRACTIONS ---
        { 
            cat: "Visual Fractions", diff: 1,
            q: "Q6. Which of the following fractions represents the <b>UNSHADED</b> part of the figure?", 
            visualType: "custom", 
            html: `<svg width="140" height="140" viewBox="0 0 100 100" style="border:2px solid #333; background:white; margin:10px auto; display:block;">
                     <path d="M0,0 L100,100 M100,0 L0,100" stroke="#333" stroke-width="2"/>
                     <path d="M0,0 L50,50 L100,0 Z" fill="#3498db"/>
                    </svg>`,
            options: [f(1,4), f(3,4), f(1,2), f(1,3)], 
            correct: 1, 
            exp: `The square is divided into 4 equal triangles.<br>1 is shaded (Blue).<br>So 3 are unshaded.<br>Ans: ${f(3,4)}.` 
        },
        { 
            cat: "Visual Fractions", diff: 1,
            q: "Q7. What fraction of the set of balls is <b>SHADED</b> (Blue)?", 
            visualType: "set", total: 10, shaded: 4, 
            options: [f(4,10), f(2,5), f(1,2), f(3,5)], 
            correct: 1, 
            exp: `Total 10 balls. 4 are shaded.<br>4/10 simplifies to ${f(2,5)}.` 
        },
        { 
            cat: "Visual Fractions", diff: 1,
            q: "Q8. What fraction of the grid is <b>UNSHADED</b> (White)?", 
            visualType: "grid", rows: 3, cols: 4, shaded: 5, 
            options: [f(5,12), f(7,12), f(1,2), f(1,3)], 
            correct: 1, 
            exp: `Total 12 squares. 5 are shaded.<br>12 - 5 = 7 unshaded.<br>Ans: ${f(7,12)}.` 
        },
        { 
            cat: "Visual Fractions", diff: 2,
            q: "Q9. The large equilateral triangle is divided into smaller identical triangles. What fraction of the figure is <b>SHADED</b>?", 
            visualType: "custom", 
            html: `<svg width="160" height="140" viewBox="0 0 100 87" style="background:white; margin:10px auto; display:block;">
                     <polygon points="50,0 0,87 100,87" fill="none" stroke="#333" stroke-width="1.5"/>
                     <polygon points="25,43.5 75,43.5 50,87" fill="none" stroke="#333" stroke-width="1.5"/>
                     <polygon points="37.5,21.75 62.5,21.75 50,43.5" fill="none" stroke="#333" stroke-width="1.5"/>
                     <polygon points="50,0 37.5,21.75 62.5,21.75" fill="#3498db" stroke="#333" stroke-width="1.5"/>
                    </svg>`,
            options: [f(1,4), f(1,8), f(1,16), f(1,12)], 
            correct: 2, 
            exp: `The large triangle is made of 4 Medium triangles.<br>The top Medium triangle is made of 4 Small triangles.<br>Total Small triangles = 4 √ó 4 = 16.<br>1 shaded = ${f(1,16)}.` 
        },

        // --- DECIMALS ---
        { 
            cat: "Decimals", diff: 1,
            q: `Q10. Express ${f(7,10)} as a decimal.`, 
            options: ["0.07", "7.0", "0.7", "0.77"], 
            correct: 2, 
            exp: "7 tenths = 0.7" 
        },
        { 
            cat: "Decimals", diff: 2,
            q: `Q11. Express ${m(1,4,5)} as a decimal.`, 
            options: ["1.4", "1.5", "1.45", "1.8"], 
            correct: 3, 
            exp: `Whole number is 1.<br>${f(4,5)} = ${f(8,10)} = 0.8.<br>Total: 1.8.` 
        },
        { 
            cat: "Decimals", diff: 3,
            q: `Q12. Express ${f(27,4)} as a decimal.`, 
            options: ["6.25", "6.75", "6.4", "6.8"], 
            correct: 1, 
            exp: `<b>Strategy:</b> ${f(27,4)} = ${m(6,3,4)}.<br>We know ${f(3,4)} = 0.75.<br>Ans: <b>6.75</b>.` 
        },

        // --- NUMBER LINE ---
        { 
            cat: "Number Line", diff: 1,
            q: "Q13. What fraction is exactly halfway between 0 and 1?", 
            visualType: "line", start: "0", end: "1", pointPos: 50, pointLabel: "?", 
            options: [f(1,4), f(1,2), f(3,4), f(1,3)], 
            correct: 1, 
            exp: "Halfway is 1/2." 
        },
        { 
            cat: "Number Line", diff: 2,
            q: `Q14. The line is marked in steps of ${f(1,5)}. What is the value of the 3rd mark?`, 
            visualType: "line", start: "0", end: "1", ticks: [20, 40, 60, 80], pointPos: 60, pointLabel: "?", 
            options: [f(3,5), f(1,3), f(2,5), f(5,3)], 
            correct: 0, 
            exp: `Counting: 1/5, 2/5, ${f(3,5)}.` 
        },
        { 
            cat: "Number Line", diff: 3,
            q: `Q15. What is the fraction exactly halfway between ${f(1,3)} and ${f(2,3)}?`, 
            visualType: "line", start: "1/3", end: "2/3", pointPos: 50, pointLabel: "?", 
            options: [f(1,2), f(1,4), f(4,9), f(3,5)], 
            correct: 0, 
            exp: `Common Denom 6: ${f(2,6)} and ${f(4,6)}.<br>The middle is ${f(3,6)} = ${f(1,2)}.` 
        },

        // --- ORDERING ---
        { 
            cat: "Ordering", diff: 2,
            q: `Q16. Which fraction is <b>closest to ${f(1,2)}</b>?`, 
            options: [f(1,5), f(4,10), f(6,11), f(1,10)], 
            correct: 2, 
            exp: "Half of 11 is 5.5.<br>6/11 is very close to half." 
        },
        { 
            cat: "Ordering", diff: 2,
            q: `Q17. Which fraction is <b>closest to 1</b>?`, 
            options: [f(3,4), f(5,6), f(8,9), f(2,3)], 
            correct: 2, 
            exp: "1/9 is the smallest gap to 1.<br>So 8/9 is the closest." 
        },
        { 
            cat: "Ordering", diff: 2,
            q: `Q18. Arrange from <b>Smallest to Largest</b>:`, 
            visualType: "custom", html: `<div style="font-size:1.3em;text-align:center;padding:10px;">${f(2,3)}, ${f(1,4)}, ${f(1,2)}</div>`, 
            options: [`${f(1,4)}, ${f(1,2)}, ${f(2,3)}`, `${f(1,2)}, ${f(1,4)}, ${f(2,3)}`, `${f(1,4)}, ${f(2,3)}, ${f(1,2)}`, `${f(2,3)}, ${f(1,2)}, ${f(1,4)}`], 
            correct: 0, 
            exp: `Convert to 12ths:<br>3/12, 6/12, 8/12.` 
        },
        { 
            cat: "Ordering", diff: 3,
            q: `Q19. Arrange from <b>Largest to Smallest</b>:`, 
            visualType: "custom", html: `<div style="font-size:1.3em;text-align:center;padding:10px;">${f(11,6)}, ${m(1,2,3)}, ${f(7,4)}</div>`, 
            options: [`${f(11,6)}, ${f(7,4)}, ${m(1,2,3)}`, `${m(1,2,3)}, ${f(7,4)}, ${f(11,6)}`, `${f(7,4)}, ${f(11,6)}, ${m(1,2,3)}`, `${f(11,6)}, ${m(1,2,3)}, ${f(7,4)}`], 
            correct: 0, 
            exp: `11/6 (22/12) is Largest.<br>7/4 (21/12).<br>1 2/3 (20/12) is Smallest.` 
        },

        // --- OPERATIONS ---
        { 
            cat: "Multiplication", diff: 1,
            q: `Q20. Find the value of ${f(1,2)} √ó ${f(1,4)}.`, 
            options: [f(1,6), f(2,8), f(1,8), f(2,4)], 
            correct: 2, 
            exp: `1√ó1=1, 2√ó4=8.<br>Ans: ${f(1,8)}` 
        },
        { 
            cat: "Multiplication", diff: 2,
            q: `Q21. Calculate ${f(3,5)} of 20kg.`, 
            options: ["10kg", "12kg", "15kg", "8kg"], 
            correct: 1, 
            exp: "20 √∑ 5 = 4.<br>4 √ó 3 = 12kg." 
        },
        { 
            cat: "Division (KCF)", diff: 2,
            q: `Q22. Find the value of 2 √∑ ${f(1,5)}.`, 
            visualType: "custom", html: `<div style="text-align:center; font-style:italic;">How many fifths in 2 wholes?</div>`, 
            options: [f(2,5), "10", "5", "0.4"], 
            correct: 1, 
            exp: `Keep 2. Change √∑ to √ó. Flip ${f(1,5)} to 5.<br>2 √ó 5 = 10.` 
        },
        { 
            cat: "Division (KCF)", diff: 3,
            q: `Q23. Find the value of ${f(5,9)} √∑ 5.`, 
            options: [f(1,9), f(25,9), f(1,5), "9"], 
            correct: 0, 
            exp: `Keep ${f(5,9)}. Change √∑ to √ó. Flip 5 to ${f(1,5)}.<br>Result: ${f(1,9)}.` 
        },
        { 
            cat: "Division (KCF)", diff: 3,
            q: `Q24. Find the value of ${f(3,4)} √∑ ${f(1,8)}.`, 
            options: ["6", f(3,32), "4", "8"], 
            correct: 0, 
            exp: `KCF: ${f(3,4)} √ó 8 = 24/4 = 6.` 
        },
        { 
            cat: "Division (KCF)", diff: 3,
            q: `Q25. Mrs Tan packs ${f(1,2)}kg sugar into ${f(1,8)}kg bags. How many bags?`, 
            options: ["2", "4", "8", "6"], 
            correct: 1, 
            exp: `${f(1,2)} √∑ ${f(1,8)} = 4 bags.` 
        }
    ];

    let currentIdx = 0, score = 0;
    let studentName = "";
    let sessionQuestions = [];
    let currentMode = "topic";
    let startTime; // Variable to store start time
    window.submitted = false; // Flag for iframe

    // Helper: Fisher-Yates Shuffle
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // MODE 1: Group by Topic
    function getQuestionsByTopic() {
        const groups = {};
        const groupOrder = [];
        questions.forEach(q => {
            if (!groups[q.cat]) {
                groups[q.cat] = [];
                groupOrder.push(q.cat); 
            }
            groups[q.cat].push(q);
        });
        let finalOrder = [];
        groupOrder.forEach(cat => {
            const groupQs = groups[cat];
            shuffleArray(groupQs);
            finalOrder = finalOrder.concat(groupQs);
        });
        return finalOrder;
    }

    // MODE 2: Group by Difficulty
    function getQuestionsByDifficulty() {
        const easy = questions.filter(q => q.diff === 1);
        const med = questions.filter(q => q.diff === 2);
        const hard = questions.filter(q => q.diff === 3);
        shuffleArray(easy);
        shuffleArray(med);
        shuffleArray(hard);
        return [...easy, ...med, ...hard];
    }

    function startQuiz() {
        const nameInput = document.getElementById("studentName");
        const modeInput = document.getElementById("quizMode");
        if (nameInput.value.trim() === "") {
            alert("Please enter your name first!");
            return;
        }
        studentName = nameInput.value.trim();
        currentMode = modeInput.value;
        score = 0;
        currentIdx = 0;
        
        // Start Timer Here
        startTime = new Date();
        
        if (currentMode === "topic") {
            sessionQuestions = getQuestionsByTopic();
        } else {
            sessionQuestions = getQuestionsByDifficulty();
        }

        document.getElementById("startScreen").style.display = "none";
        document.getElementById("gameUI").style.display = "block";
        loadQuestion();
    }

    function renderVisual(q) {
        const vArea = document.getElementById("visualArea");
        vArea.style.display = "flex"; vArea.innerHTML = "";
        if (!q.visualType) { vArea.style.display = "none"; return; }

        if (q.visualType === "pie") {
            vArea.className = "visual-container";
            const deg = (q.shaded / q.total) * 360;
            const sliceDeg = 360 / q.total;
            const lines = `repeating-conic-gradient(from 0deg, transparent 0deg ${sliceDeg-2}deg, #333 ${sliceDeg-2}deg ${sliceDeg}deg)`;
            const fill = `conic-gradient(#3498db 0deg ${deg}deg, white ${deg}deg 360deg)`;
            vArea.innerHTML = `<div class="pie-visual" style="background: ${lines}, ${fill};"></div>`;
        }
        else if (q.visualType === "grid") {
            vArea.className = "visual-container";
            let html = `<div class="grid-visual" style="grid-template-columns: repeat(${q.cols}, 40px);">`;
            for(let i=0; i<(q.rows*q.cols); i++) html += `<div class="grid-cell ${i<q.shaded?'shaded':''}"></div>`;
            html += `</div>`;
            vArea.innerHTML = html;
        }
        else if (q.visualType === "set") {
            vArea.className = "visual-container";
            let html = `<div class="set-visual">`;
            for(let i=0; i<q.total; i++) html += `<div class="set-item ${i<q.shaded?'shaded':''}"></div>`;
            html += `</div>`;
            vArea.innerHTML = html;
        }
        else if (q.visualType === "line") {
            vArea.className = "visual-container";
            let ticksHtml = "";
            if (q.ticks) q.ticks.forEach(t => { ticksHtml += `<div class="nl-tick" style="left:${t}%"></div>`; });
            vArea.innerHTML = `
                <div style="width:100%; position:relative; height:60px;">
                    <div class="nl-line">
                        <div class="nl-tick" style="left:0%"></div><div class="nl-label" style="left:0%">${q.start}</div>
                        <div class="nl-tick" style="left:100%"></div><div class="nl-label" style="left:100%">${q.end}</div>
                        ${ticksHtml}
                        <div class="nl-point" style="left:${q.pointPos}%"><div class="nl-point-label">${q.pointLabel}</div></div>
                    </div>
                </div>`;
        }
        else if (q.visualType === "custom") {
            vArea.innerHTML = q.html;
        }
    }

    function loadQuestion() {
        if (currentIdx >= sessionQuestions.length) { showEndScreen(); return; }
        const q = sessionQuestions[currentIdx];
        let cleanQText = q.q.replace(/^Q\d+\.\s*/, "");
        
        document.getElementById("catLabel").innerText = q.cat;
        const diffLabel = document.getElementById("diffLabel");
        if(currentMode === "mastery") {
            diffLabel.style.display = "block";
            const diffText = q.diff === 1 ? "EASY" : q.diff === 2 ? "MEDIUM" : "HARD";
            const diffColor = q.diff === 1 ? "#2ecc71" : q.diff === 2 ? "#f1c40f" : "#e74c3c";
            diffLabel.innerText = diffText;
            diffLabel.style.backgroundColor = diffColor;
        } else {
            diffLabel.style.display = "none";
        }

        document.getElementById("qText").innerHTML = `Q${currentIdx + 1}. ${cleanQText}`;
        document.getElementById("progressBar").style.width = ((currentIdx / sessionQuestions.length) * 100) + "%";
        renderVisual(q);
        
        const optsDiv = document.getElementById("optionsArea");
        optsDiv.innerHTML = "";

        let optIndices = q.options.map((_, i) => i);
        shuffleArray(optIndices);

        optIndices.forEach((originalIndex) => {
            const btn = document.createElement("button");
            btn.className = "option-btn"; 
            btn.innerHTML = q.options[originalIndex];
            btn.setAttribute('data-original-index', originalIndex);
            btn.onclick = () => checkAnswer(originalIndex, btn);
            optsDiv.appendChild(btn);
        });

        document.getElementById("feedbackArea").style.display = "none";
        document.getElementById("nextBtn").style.display = "none";
    }

    function checkAnswer(originalIndex, btn) {
        const q = sessionQuestions[currentIdx];
        const feedback = document.getElementById("feedbackArea");
        document.querySelectorAll(".option-btn").forEach(b => b.disabled = true);
        
        if (originalIndex === q.correct) {
            score++; btn.classList.add("correct");
            feedback.innerHTML = `<h3 style="color:#27ae60;margin:0">‚úÖ Correct!</h3><p>${q.exp}</p>`;
            feedback.className = "feedback correct";
        } else {
            btn.classList.add("wrong");
            const correctBtn = document.querySelector(`.option-btn[data-original-index='${q.correct}']`);
            if(correctBtn) correctBtn.classList.add("correct");
            feedback.innerHTML = `<h3 style="color:#c0392b;margin:0">‚ùå Correction</h3><p>Correct: <b>${q.options[q.correct]}</b></p><p>${q.exp}</p>`;
            feedback.className = "feedback wrong";
        }
        feedback.style.display = "block";
        document.getElementById("nextBtn").style.display = "block";
    }

    function nextQuestion() { currentIdx++; loadQuestion(); }
    
    // --- ROBUST SUBMISSION METHOD (IFRAME + FORM) ---
    function submitToGoogleForm(name, score, total, mode, durationString) {
        const statusDiv = document.getElementById("submitStatus");
        statusDiv.style.display = "block";
        statusDiv.innerHTML = "‚è≥ Sending results...";
        statusDiv.style.color = "#2c3e50";

        // 1. Prepare Hidden Form
        const form = document.getElementById("hidden_form");
        form.action = GOOGLE_FORM_URL;
        
        // Map data to inputs
        document.getElementById("form_name").name = ENTRY_IDS.name;
        document.getElementById("form_name").value = name;
        
        document.getElementById("form_score").name = ENTRY_IDS.score;
        // APPEND TIME TO SCORE FIELD
        document.getElementById("form_score").value = `${score} / ${total} (Time: ${durationString})`;
        
        document.getElementById("form_mode").name = ENTRY_IDS.mode;
        document.getElementById("form_mode").value = mode;

        // 2. Submit
        window.submitted = true;
        form.submit();
        
        // Note: The 'onload' of the iframe will trigger the success message
    }

    function showEndScreen() {
        const endTime = new Date();
        const timeDiff = endTime - startTime; // in ms
        const seconds = Math.floor((timeDiff / 1000) % 60);
        const minutes = Math.floor((timeDiff / (1000 * 60)) % 60);
        const durationString = `${minutes}m ${seconds}s`;

        const pct = Math.round((score / sessionQuestions.length) * 100);
        const modeText = currentMode === 'topic' ? 'Topic Order' : 'Mastery (Mixed)';
        
        // Manual Pre-filled link generation for Backup Button (Includes Duration in Score)
        const baseUrl = GOOGLE_FORM_URL.replace("formResponse", "viewform");
        const scoreWithTime = `${score}/${sessionQuestions.length} (Time: ${durationString})`;
        const backupLink = `${baseUrl}?usp=pp_url&${ENTRY_IDS.name}=${encodeURIComponent(studentName)}&${ENTRY_IDS.score}=${encodeURIComponent(scoreWithTime)}&${ENTRY_IDS.mode}=${encodeURIComponent(modeText)}`;

        document.querySelector(".quiz-container").innerHTML = `
            <div style="text-align:center; padding:30px;">
                <h1>üéâ Quiz Complete!</h1>
                <div class="result-card">
                    <h2 style="color:#2c3e50; margin:0;">Result Slip</h2>
                    <h3 style="color:#7f8c8d;">Student: ${studentName}</h3>
                    <h2 style="font-size:3em; margin:20px 0; color:#3498db;">${score} / ${sessionQuestions.length}</h2>
                    <p style="font-size:1.1em; font-weight:bold; color:#e67e22;">‚è±Ô∏è Time Taken: ${durationString}</p>
                    <h3>${pct >= 85 ? "üèÜ Excellent!" : "üí™ Keep Practicing!"}</h3>
                    <p style="font-size:0.9em;color:#95a5a6">${new Date().toLocaleString()}</p>
                    <div id="submitStatus"></div>
                    
                    <br>
                    <div style="font-size:0.9em; color:#7f8c8d; margin-top:15px;">
                        Is the result not sending automatically?
                        <br>
                        <a href="${backupLink}" target="_blank" class="manual-link">üîó Click here to submit manually</a>
                    </div>
                </div>
                
                <button class="btn-retry" style="margin-top:20px;" onclick="location.reload()">Try Again</button>
            </div>`;

        // Automatically submit results
        setTimeout(() => submitToGoogleForm(studentName, score, sessionQuestions.length, modeText, durationString), 1000);
    }
</script>
</body>
</html>
