<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ratio Rescue: PSLE Edition (Home Learning)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        // ==========================================================================================
        //  TEACHER CONFIGURATION AREA
        // ==========================================================================================
        
        // Google Form Base Link (Corrected for POST submission)
        const FORM_ACTION_URL   = "https://docs.google.com/forms/d/e/1FAIpQLScSVH5G5QVKCtmbbtt08CHX9--ecu5ZfO2ZHAC03hGPR_FCPw/formResponse"; 
        
        // Entry IDs
        const ENTRY_ID_NAME     = "entry.1376623119"; 
        const ENTRY_ID_SCORE    = "entry.2032202022"; 
        const ENTRY_ID_LEVEL    = "entry.1918358329"; 

        // Teacher Email
        const TEACHER_EMAIL     = "newtonlabtuition@gmail.com"; 

        // ==========================================================================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose config to window
        window.teacherConfig = {
            formAction: FORM_ACTION_URL,
            entryName: ENTRY_ID_NAME,
            entryScore: ENTRY_ID_SCORE,
            entryLevel: ENTRY_ID_LEVEL,
            email: TEACHER_EMAIL
        };

        window.firebaseState = { db: null, user: null, appId: 'p6-ratio-rescue', isOnline: false };

        const initFirebase = async () => {
            try {
                // Your ACTUAL Firebase Configuration
                const firebaseConfig = {
                  apiKey: "AIzaSyDwmyq_qNfTmFT2qHY9kSH-ygXQcwjjMwU",
                  authDomain: "p6-ratio-rescue.firebaseapp.com",
                  projectId: "p6-ratio-rescue",
                  storageBucket: "p6-ratio-rescue.firebasestorage.app",
                  messagingSenderId: "575502213103",
                  appId: "1:575502213103:web:2e5ed6a7d9c9085e71e01a",
                  measurementId: "G-J82VH6JB69"
                };

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                window.firebaseState.db = db;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.firebaseState.user = user;
                        window.firebaseState.isOnline = true;
                        window.updateConnectionStatus(true);
                    }
                });
                
                // Anonymously sign in the student's browser so they can write to the database
                await signInAnonymously(auth);
                
            } catch (e) {
                console.log("⚠️ Offline Mode (Could not connect to Firebase):", e.message);
                window.updateConnectionStatus(false);
            }
        };
        initFirebase();

        window.saveStudentResult = async (studentName, score, level, detailedLog) => {
            if (!window.firebaseState.isOnline || !window.firebaseState.db) return false;
            try {
                const colRef = collection(window.firebaseState.db, 'artifacts', window.firebaseState.appId, 'public', 'data', 'student_results');
                await addDoc(colRef, { studentName, score, maxLevelReached: level, timestamp: serverTimestamp(), details: detailedLog });
                return true;
            } catch (e) { 
                console.error("Save Error:", e);
                return false; 
            }
        };
        
        window.listenToResults = (callback) => {
            if (!window.firebaseState.isOnline || !window.firebaseState.db) { callback([]); return; }
            const colRef = collection(window.firebaseState.db, 'artifacts', window.firebaseState.appId, 'public', 'data', 'student_results');
            const q = query(colRef);
            return onSnapshot(q, (snapshot) => {
                const results = [];
                snapshot.forEach(doc => results.push({ id: doc.id, ...doc.data() }));
                results.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                callback(results);
            });
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Press+Start+2P&display=swap');
        :root { --primary-color: #6d28d9; --bg-color: #1e1b4b; --text-color: #e0e7ff; }
        body { font-family: 'Fredoka', sans-serif; background-color: var(--bg-color); color: var(--text-color); background-image: radial-gradient(circle at 10% 20%, rgb(33, 27, 78) 0%, rgb(24, 20, 60) 90.2%); min-height: 100vh; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .option-btn { transition: all 0.2s; border-bottom: 4px solid #b91c1c; }
        .option-btn:active { transform: translateY(2px); border-bottom: 0px solid; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .ai-btn { background: linear-gradient(90deg, #6d28d9, #db2777); background-size: 200% 100%; animation: shimmer 5s infinite linear; border: 2px solid #facc15; box-shadow: 0 0 15px rgba(219, 39, 119, 0.5); }
        .ai-btn:hover { box-shadow: 0 0 25px rgba(219, 39, 119, 0.8); transform: scale(1.02); }
        .sage-box { border-left: 4px solid #db2777; background: rgba(219, 39, 119, 0.15); }
        .feedback-correct { animation: pulse-green 1s infinite; border-color: #4ade80; }
        .feedback-wrong { animation: pulse-red 1s infinite; border-color: #ef4444; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .hero-img { animation: float 3s ease-in-out infinite; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        
        .modal-overlay { background-color: rgba(0,0,0,0.85); z-index: 50; }
        #leaderboard-modal { z-index: 60; }
        #shop-modal { z-index: 70; }
        
        .dashboard-table th { text-align: left; padding: 12px; color: #facc15; border-bottom: 2px solid #4c1d95; }
        .dashboard-table td { padding: 12px; border-bottom: 1px solid #4c1d95; }
        .dashboard-table tr:hover { background: rgba(255,255,255,0.05); }
        #loading-overlay { z-index: 200; }
        
        .gold-row { background: rgba(255, 215, 0, 0.15) !important; border-left: 4px solid gold; }
        .silver-row { background: rgba(192, 192, 192, 0.15) !important; border-left: 4px solid silver; }
        .bronze-row { background: rgba(205, 127, 50, 0.15) !important; border-left: 4px solid #cd7f32; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <!-- Hidden Form for Auto-Submission -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
    <form action="" method="post" target="hidden_iframe" id="google-form" style="display:none;">
        <input type="text" name="" id="form-name">
        <input type="text" name="" id="form-score">
        <input type="text" name="" id="form-level">
    </form>

    <!-- Main Menu Screen -->
    <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <div class="mb-6">
            <i class="fas fa-scroll text-6xl text-yellow-400 mb-4 hero-img"></i>
            <h1 class="text-4xl md:text-5xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-yellow-400 pixel-font" style="line-height: 1.4;">RATIO<br>RESCUE</h1>
            <p class="text-sm text-blue-200 mt-2 tracking-widest uppercase">Student Edition</p>
        </div>
        
        <div class="card p-8 max-w-md w-full mb-8 relative">
            <div class="mb-6">
                <label class="block text-left text-sm font-bold mb-2 text-pink-300">Enter Your Name</label>
                <input type="text" id="student-name-input" placeholder="e.g., Joy Tan" class="w-full bg-gray-800 text-white border-2 border-purple-500 rounded-lg p-3 focus:outline-none focus:border-yellow-400 transition">
            </div>

            <button onclick="checkNameAndStart()" id="start-btn" disabled class="w-full bg-gray-600 text-gray-400 font-bold py-4 px-6 rounded-xl shadow-lg transition pixel-font mb-4 cursor-not-allowed">
                <i class="fas fa-circle-notch fa-spin mr-2"></i> CONNECTING...
            </button>
            
             <div class="flex gap-2">
                <button onclick="showLeaderboard()" class="w-1/2 bg-gray-700 hover:bg-gray-600 text-yellow-400 text-xs font-bold py-2 px-4 rounded-lg transition border border-gray-600">
                    <i class="fas fa-trophy mr-2"></i> Leaderboard
                </button>
                <button onclick="openTeacherPortal()" id="teacher-btn" class="w-1/2 bg-transparent border border-gray-500 text-gray-400 hover:text-white hover:border-white text-xs font-bold py-2 px-4 rounded-lg transition">
                    <i class="fas fa-chalkboard-teacher mr-2"></i> Teachers
                </button>
            </div>
        </div>
        
        <p class="text-xs text-gray-500" id="connection-status">Initializing...</p>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center px-4">
        <div class="card p-6 max-w-lg w-full bg-gray-900 border border-yellow-500 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-yellow-400 pixel-font"><i class="fas fa-trophy mr-2"></i> HALL OF FAME</h3>
                <button onclick="closeLeaderboard()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm dashboard-table">
                    <thead>
                        <tr>
                            <th class="w-16">Rank</th>
                            <th>Hero Name</th>
                            <th>Best Score</th>
                            <th>Attempts</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-purple-500"></i><br>Summoning Records...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Shop / Continue Modal -->
    <div id="shop-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center px-4">
        <div class="card p-8 max-w-md w-full bg-gray-900 border-2 border-red-500 text-center">
            <div class="mb-6">
                <i class="fas fa-heart-broken text-5xl text-red-500 mb-2"></i>
                <h2 class="text-2xl font-bold text-white pixel-font">OUT OF HEARTS!</h2>
                <p class="text-gray-400 mt-2">But wait! You can buy a second chance.</p>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-yellow-500">
                <p class="text-sm text-yellow-400 uppercase tracking-widest mb-1">Your Current Score</p>
                <p class="text-3xl font-bold text-white" id="shop-score-display">0</p>
            </div>

            <div class="space-y-3">
                <button onclick="buyContinue()" id="buy-btn" class="w-full bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg border-2 border-green-400">
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-heart text-red-400 mr-2"></i> Refill Hearts</span>
                        <span class="bg-black bg-opacity-30 px-2 py-1 rounded text-sm">-500 Pts</span>
                    </div>
                </button>
                
                <button onclick="giveUp()" class="w-full bg-transparent border border-gray-600 text-gray-400 hover:text-white hover:border-white py-3 rounded-lg text-sm">
                    No thanks, I'll end here.
                </button>
            </div>
        </div>
    </div>

    <!-- Teacher Portal -->
    <div id="teacher-portal" class="hidden min-h-screen p-4 md:p-8 bg-gray-900">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-yellow-400"><i class="fas fa-chart-line mr-2"></i> Teacher Dashboard</h2>
                <div class="flex gap-2">
                     <button onclick="showInstructions()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg"><i class="fas fa-share-alt mr-2"></i> Setup Guide</button>
                    <button onclick="closeTeacherPortal()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Exit</button>
                </div>
            </div>
            
            <div class="card p-6 overflow-x-auto">
                <table class="w-full text-sm dashboard-table">
                    <thead>
                        <tr><th>Student</th><th>Score</th><th>Lvl</th><th>Date</th><th>Analysis</th></tr>
                    </thead>
                    <tbody id="results-table-body">
                        <tr><td colspan="5" class="text-center text-gray-500 py-4">Checking database...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysis-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4">
        <div class="card p-6 max-w-2xl w-full bg-gray-900 border border-purple-500 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="analysis-student-name" class="text-xl font-bold text-white">Student Analysis</h3>
                    <p class="text-xs text-gray-400">Powered by Gemini AI</p>
                </div>
                <button onclick="closeAnalysis()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="analysis-content" class="text-sm text-gray-300 space-y-4"></div>
        </div>
    </div>
    
    <!-- Instructions Modal -->
    <div id="instructions-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4">
        <div class="card p-6 max-w-lg w-full bg-gray-900 border border-blue-500">
            <h3 class="text-xl font-bold text-white mb-4">Setup for Home Learning</h3>
            <ol class="list-decimal list-inside text-sm text-gray-300 space-y-3 mb-6">
                <li><strong>Download:</strong> Save this file as <code>ratio_game.html</code>.</li>
                <li><strong>Auto-Fill Form (Recommended):</strong>
                    <ul class="list-disc list-inside ml-4 text-xs mt-1 text-gray-400">
                        <li>Create a Google Form (Name, Score, Level).</li>
                        <li>Use "Get pre-filled link" to find the Entry IDs (e.g. entry.12345).</li>
                        <li>Edit this file and paste the IDs into the <code>TEACHER CONFIGURATION</code> section at the top.</li>
                    </ul>
                </li>
                <li><strong>Email Backup:</strong> Simply add your email to <code>TEACHER_EMAIL</code> in the config.</li>
                <li><strong>Distribute:</strong> Send the file to students!</li>
            </ol>
            <button onclick="document.getElementById('instructions-modal').classList.add('hidden')" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">Got it</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-5xl text-purple-500 mb-4"></i>
        <p class="text-white font-bold text-lg pixel-font">Summoning...</p>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden min-h-screen flex flex-col items-center justify-start pt-4 pb-12">
        <div class="w-full max-w-2xl px-4 mb-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-gray-800 p-2 rounded-lg border border-gray-600">
                    <span class="text-xs text-gray-400 block">LEVEL</span>
                    <span id="level-display" class="font-bold text-yellow-400">1</span>
                </div>
                <div class="bg-gray-800 p-2 rounded-lg border border-gray-600 min-w-[80px]">
                    <span class="text-xs text-gray-400 block">SCORE</span>
                    <span id="score-display" class="font-bold text-green-400">0</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="bg-gray-800 p-2 px-3 rounded-lg border border-gray-600 flex items-center">
                    <i class="fas fa-clock text-blue-400 mr-2"></i>
                    <span id="timer-display" class="font-mono font-bold text-white">00:00</span>
                </div>
                <div class="flex space-x-1" id="hearts-container"></div>
            </div>
        </div>

        <div class="w-full max-w-2xl px-4">
            <div id="question-card" class="card p-6 md:p-8 relative">
                <div class="absolute -top-4 left-6 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-lg" id="question-tag">Category</div>
                
                <button onclick="askSage()" id="sage-btn" class="absolute -top-4 right-6 ai-btn text-white text-xs font-bold px-4 py-2 rounded-full uppercase tracking-wider shadow-lg flex items-center gap-2 transition-all">
                    <i class="fas fa-magic"></i> Ask the Sage
                </button>

                <div id="sage-area" class="hidden mb-6 sage-box p-4 rounded-lg text-sm text-pink-100 relative mt-6">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-hat-wizard text-2xl text-pink-400"></i>
                        <div class="flex-1">
                            <p class="font-bold text-pink-400 mb-1">The Sage Says:</p>
                            <p id="sage-text" class="italic"></p>
                        </div>
                    </div>
                </div>

                <div class="mb-8 mt-6">
                    <p id="question-text" class="text-lg md:text-xl font-bold leading-relaxed text-center"></p>
                </div>

                <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                <div id="feedback-area" class="mt-6 hidden">
                    <div id="feedback-message" class="p-4 rounded-lg mb-4 font-bold text-center"></div>
                    <div id="explanation-box" class="bg-gray-800 p-4 rounded-lg text-sm text-gray-200 border-l-4 border-yellow-400">
                        <p class="font-bold text-yellow-400 mb-1">Solution:</p>
                        <p id="explanation-text"></p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                        <button id="generate-btn" onclick="generateSimilarQuestion()" class="ai-btn text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-plus-circle"></i> Similar Question
                        </button>
                        <button id="next-btn" onclick="nextQuestion()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2">
                            Next Question <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- End Modal (Game Over) -->
    <div id="end-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4">
        <div class="card p-8 max-w-md w-full text-center bg-gray-900 border-2 border-purple-500">
            <div id="end-icon" class="text-6xl mb-4"><i class="fas fa-graduation-cap text-yellow-400"></i></div>
            <h2 id="end-title" class="text-3xl font-bold mb-2 pixel-font text-white">QUIZ COMPLETED!</h2>
            <p id="end-message" class="text-gray-300 mb-6">Well done on finishing the assignment!</p>
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <div class="text-sm text-gray-400">FINAL SCORE</div>
                <div id="final-score" class="text-4xl font-bold text-yellow-400">0</div>
            </div>
            
            <div id="player-stats-display" class="mb-6 p-3 bg-gray-800 rounded border border-gray-600 text-sm">
                <p><i class="fas fa-history text-blue-400"></i> Attempts: <span id="end-attempts" class="font-bold text-white">...</span></p>
                <p><i class="fas fa-trophy text-yellow-400"></i> Rank: <span id="end-rank" class="font-bold text-white">...</span></p>
            </div>
            
            <div id="save-status" class="text-xs text-gray-400 mb-4 space-y-2"></div>
            
            <!-- Dynamic Buttons Area -->
            <div id="submission-buttons" class="space-y-3 mb-6"></div>
            
            <div class="flex gap-2">
                <button onclick="showLeaderboard()" class="w-1/2 bg-gray-700 hover:bg-gray-600 text-yellow-400 font-bold py-3 px-4 rounded-lg border border-gray-500">
                    <i class="fas fa-trophy"></i> Ranks
                </button>
                <button onclick="location.reload()" class="w-1/2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">
                    Menu
                </button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // Environment provided

        // --- Question Database (25 Questions) ---
        const questions = [
            // Level 1: Foundations
            { level: 1, category: "Simplification", text: "Express the ratio 12 : 16 in its simplest form.", options: ["3 : 4", "4 : 3", "6 : 8", "2 : 3"], correctIndex: 0, explanation: "Find the Highest Common Factor (HCF) for 12 and 16, which is 4. Divide both numbers by 4." },
            { level: 1, category: "Missing Value", text: "Find the missing number in the box: <br> 2 : 5 = [ ? ] : 15", options: ["6", "10", "5", "4"], correctIndex: 0, explanation: "Look at the right side: 5 × 3 = 15. Whatever you do to one side, you must do to the other! So, 2 × 3 = 6." },
            { level: 1, category: "Ordering", text: "There are 8 boys and 12 girls in a class. What is the ratio of the number of girls to the number of boys?", options: ["2 : 3", "3 : 2", "8 : 12", "4 : 6"], correctIndex: 1, explanation: "Order matters! The question asks for Girls first, then Boys. Girls : Boys = 12 : 8. Simplify by dividing by 4 to get 3 : 2." },
            { level: 1, category: "Units", text: "Express 30 cm : 1 m as a ratio in its simplest form.", options: ["30 : 1", "3 : 1", "3 : 10", "30 : 100"], correctIndex: 2, explanation: "You must make the units the same before comparing. Convert 1 m to 100 cm. The ratio is 30 : 100. Divide both by 10 to get 3 : 10." },
            { level: 1, category: "Simplification", text: "Express the ratio 18 : 27 in its simplest form.", options: ["2 : 3", "3 : 2", "6 : 9", "9 : 6"], correctIndex: 0, explanation: "Divide both numbers by their highest common factor, which is 9." },

            // Level 2: Ratio, Fraction & Percentage
            { level: 2, category: "Ratio to Fraction", text: "The ratio of red balls to blue balls in a bag is 5 : 7. What fraction of the balls are red?", options: ["5/7", "7/5", "5/12", "7/12"], correctIndex: 2, explanation: "Total units = 5 (red) + 7 (blue) = 12 units. Red is 5 units. Fraction = Red / Total = 5/12." },
            { level: 2, category: "Perc to Ratio", text: "In a class, 40% of the students are boys. What is the ratio of the number of girls to the number of boys?", options: ["2 : 3", "3 : 2", "4 : 6", "60 : 40"], correctIndex: 1, explanation: "If 40% are boys, then 100% - 40% = 60% are girls. Ratio of Girls : Boys = 60 : 40. Simplify by dividing by 20 to get 3 : 2." },
            { level: 2, category: "Fraction to Ratio", text: "James has 2/3 as many stickers as Ali. What is the ratio of James's stickers to Ali's stickers?", options: ["2 : 3", "3 : 2", "2 : 1", "1 : 3"], correctIndex: 0, explanation: "The numerator (2) belongs to James. The denominator (base of 3) belongs to Ali. Ratio is 2 : 3." },
            { level: 2, category: "Grouping", text: "The ratio of adults to children at a party is 2 : 3. Among the children, the ratio of girls to boys is 4 : 1. What is the ratio of adults to girls?", options: ["2 : 4", "5 : 6", "5 : 4", "10 : 12"], correctIndex: 1, explanation: "Total children = 5 units (4 girls + 1 boy). Make the 'children' units match. LCM of 3 and 5 is 15. Adults:Children becomes 10:15. Girls:Boys becomes 12:3. Adults:Girls = 10 : 12 = 5 : 6." },
            { level: 2, category: "Ratio to Fraction", text: "A recipe uses 3 cups of flour for every 2 cups of sugar. What fraction of the mixture is sugar?", options: ["2/5", "3/5", "2/3", "3/2"], correctIndex: 0, explanation: "Total mixture = 3 + 2 = 5 parts. Sugar is 2 parts. Fraction is 2/5." },

            // Level 3: Repeated Identity
            { level: 3, category: "Repeated Identity", text: "Given that A : B = 2 : 3 and B : C = 3 : 5, find the ratio of A : B : C.", options: ["2 : 3 : 5", "2 : 6 : 5", "6 : 9 : 15", "2 : 1 : 5"], correctIndex: 0, explanation: "B is the repeated identity. Since B is exactly '3' in both ratios, you can combine them directly: 2 : 3 : 5." },
            { level: 3, category: "Repeated Identity", text: "Given that A : B = 1 : 2 and B : C = 4 : 5, find the ratio of A : B : C.", options: ["1 : 2 : 5", "2 : 4 : 5", "1 : 4 : 5", "4 : 8 : 5"], correctIndex: 1, explanation: "B is '2' in the first ratio and '4' in the second. Make B equal to 4 by multiplying the first ratio by 2. A:B becomes 2 : 4. Combined ratio is 2 : 4 : 5." },
            { level: 3, category: "Repeated Identity", text: "The ratio of Alice's money to Bernice's money is 3 : 4. The ratio of Bernice's money to Clarissa's money is 2 : 5. What is the ratio of Alice's money to Clarissa's money?", options: ["3 : 5", "3 : 10", "6 : 20", "3 : 8"], correctIndex: 1, explanation: "Bernice is the repeated identity (4 and 2). Make Bernice equal to 4. Bernice:Clarissa becomes 4 : 10. A:B:C = 3 : 4 : 10. Therefore, Alice:Clarissa is 3 : 10." },
            { level: 3, category: "Equalizing Totals", text: "Seng kept stars in two boxes. In Box A, Gold:Silver = 1 : 5. In Box B, Gold:Silver = 1 : 2. Both boxes contain the exact same total number of stars. What is the ratio of Gold in Box A to Gold in Box B?", options: ["1 : 1", "1 : 2", "2 : 1", "1 : 5"], correctIndex: 1, explanation: "Total units in Box A = 1+5 = 6u. Total in Box B = 1+2 = 3u. Since total stars are the same, multiply Box B by 2 to make its total 6u. Box B becomes 2 : 4. Gold A is 1u, Gold B is 2u." },
            { level: 3, category: "Linking 3 Vars", text: "The ratio of red to blue pens is 1 : 3. The ratio of blue to green pens is 2 : 1. What is the ratio of red to green pens?", options: ["1 : 1", "2 : 3", "1 : 6", "2 : 1"], correctIndex: 1, explanation: "Blue is repeated (3 and 2). Make Blue equal to 6 (LCM). Red:Blue becomes 2:6. Blue:Green becomes 6:3. Red:Green is 2 : 3." },

            // Level 4: Heuristics
            { level: 4, category: "Constant Total", text: "Ali and Ben have money in the ratio 3 : 2. After Ali gives $10 to Ben, they have an equal amount of money. How much money do they have in total?", options: ["$50", "$60", "$100", "$30"], correctIndex: 2, explanation: "Concept: Constant Total (Internal Transfer). Before A:B = 3:2 (Total 5u). After A:B = 1:1 (Total 2u). Make totals the same (10u). Before: 6:4. After: 5:5. Ali dropped 1u. 1u = $10. Total (10u) = $100." },
            { level: 4, category: "Constant Diff", text: "Mr Tan is 40 years old and his son is 10 years old. In how many years' time will the ratio of Mr Tan's age to his son's age be 2 : 1?", options: ["10 yrs", "20 yrs", "5 yrs", "30 yrs"], correctIndex: 1, explanation: "Concept: Constant Difference (Age gap never changes). Diff = 40 - 10 = 30 years. In the future (2:1), the difference is 1 unit. So 1 unit = 30. The son (1 unit) will be 30 years old. 30 - 10 = 20 years from now." },
            { level: 4, category: "One Unchanged", text: "A box contains red and blue pens in the ratio 4 : 1. After adding 10 blue pens into the box, the ratio becomes 2 : 1. How many red pens are there?", options: ["20", "40", "10", "8"], correctIndex: 1, explanation: "Concept: Red pens remain Unchanged. Before R:B = 4:1. After R:B = 2:1. Make Red the same (4). After becomes 4:2. Blue increased from 1u to 2u. 1u = 10. Red (4u) = 40." },
            { level: 4, category: "Constant Total", text: "Jane and May shared some beads in the ratio 7 : 3. After Jane gave 20 beads to May, the ratio became 3 : 2. How many beads did Jane have at first?", options: ["70", "140", "100", "35"], correctIndex: 1, explanation: "Concept: Constant Total. Before Total = 10u. After Total = 5u. Multiply After by 2 so total is 10u -> 6:4. Jane went from 7u to 6u (Drop of 1u). 1u = 20. Jane at first (7u) = 140." },
            { level: 4, category: "Constant Diff", text: "Adam and Bob have savings in the ratio 3 : 1. After both of them spent $20 each, the ratio of their savings became 5 : 1. How much did Adam have at first?", options: ["$60", "$120", "$90", "$150"], correctIndex: 1, explanation: "Concept: Constant Difference (Both spent same amount). Before 3:1 (Diff 2u). After 5:1 (Diff 4u). Make Diff 4u -> Before becomes 6:2. Adam drops 6u to 5u (1u diff). 1u = $20. Adam at first (6u) = $120." },

            // Level 5: PSLE Advanced (2015-2023)
            { level: 5, category: "Constant Diff (2015)", text: "At first, Ben had $90 and Chandra had $48. Each of them bought a shirt at the same price. After that, the ratio of the amount Ben had left to Chandra's amount left was 4 : 1. How much did the shirt cost?", options: ["$34", "$42", "$30", "$14"], correctIndex: 0, explanation: "Because they spent the same amount, their difference is constant. Diff = $90 - $48 = $42. End Ratio 4:1 means Difference is 3u. 3u = $42. 1u = $14. Chandra had $14 left. Cost = $48 - $14 = $34." },
            { level: 5, category: "Branching (2023)", text: "Peggy spent 75% of her money on a calculator. She then spent 40% of her remaining money on a book. After that, she had $6.90 left. How much money did Peggy have at first?", options: ["$40", "$56", "$46", "$90"], correctIndex: 2, explanation: "Spent 75% -> Remainder is 25%. Spent 40% of Remainder -> Left with 60% of Remainder. 60% of 25% = 15% of total. 15% = $6.90. 1% = $0.46. Total (100%) = $46." },
            { level: 5, category: "Everything Changed (2020)", text: "On Friday, the ratio of boys to girls in a hall was 6 : 5. On Saturday, the number of boys increased by 50% and the number of girls decreased by 40%. What is the new ratio of boys to girls?", options: ["3 : 1", "9 : 3", "3 : 2", "5 : 4"], correctIndex: 0, explanation: "Assume 60 Boys and 50 Girls to make percentages easy. Boys +50% -> 60 + 30 = 90. Girls -40% -> 50 - 20 = 30. New Ratio 90 : 30 = 3 : 1." },
            { level: 5, category: "Before & After (2022)", text: "The number of boys and girls in a hall were in the ratio 2 : 5. After 11 boys entered the hall and half the number of girls left the hall, the ratio became 1 : 1. How many girls were there at first?", options: ["50", "110", "55", "22"], correctIndex: 1, explanation: "Girls started at 5u. Half leave -> 2.5u. Ratio 1:1 means New Boys = New Girls = 2.5u. Old Boys (2u) + 11 = 2.5u. So, 0.5u = 11. 1u = 22. Girls at first (5u) = 110." },
            { level: 5, category: "Internal Transfer (2018)", text: "Ann had a total of 285 red and blue beads. She used 45 red beads and 40% of her blue beads. The ratio of red to blue beads she had left became 1 : 3. How many blue beads did she use?", options: ["60", "90", "120", "40"], correctIndex: 2, explanation: "Logic check strategy: She used 40% (which is 2/5) of blue. This means the blue beads used must be a multiple of 2, and the original blue must be a multiple of 5. By testing the options, 120 works perfectly." }
        ];

        let currentStudentName = "";
        let currentLevel = 1;
        let score = 0;
        let hearts = 3;
        let availableQuestions = [];
        let currentQuestion = null;
        let detailedLog = [];
        let secondChanceActive = false;
        
        // Timer Variables
        let startTime = null;
        let timerInterval = null;

        // UI Helpers
        window.updateConnectionStatus = (isOnline) => {
            const statusEl = document.getElementById('connection-status');
            const btn = document.getElementById('start-btn');
            statusEl.innerHTML = isOnline ? '<i class="fas fa-wifi text-green-500"></i> Connected to Class DB' : '<i class="fas fa-signal text-yellow-500"></i> Offline Mode';
            
            btn.disabled = false;
            btn.innerHTML = 'START ADVENTURE';
            btn.classList.remove('bg-gray-600', 'cursor-not-allowed');
            btn.classList.add('bg-gradient-to-r', 'from-pink-600', 'to-purple-600', 'hover:from-pink-500', 'hover:to-purple-500', 'transform', 'hover:scale-105');
        };

        setTimeout(() => {
            const btn = document.getElementById('start-btn');
            if (btn.disabled) window.updateConnectionStatus(false);
        }, 3000);

        function checkNameAndStart() {
            const name = document.getElementById('student-name-input').value.trim();
            if (name.length < 2) { alert("Please enter your name"); return; }
            currentStudentName = name;
            startGame();
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            currentLevel = 1; score = 0; hearts = 3; detailedLog = [];
            
            // Start Timer
            startTime = Date.now();
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            updateHUD(); loadLevel(1);
        }
        
        function updateTimer() {
            const now = Date.now();
            const diff = Math.floor((now - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }

        function updateHUD() {
            document.getElementById('level-display').innerText = currentLevel;
            document.getElementById('score-display').innerText = score;
            const container = document.getElementById('hearts-container');
            container.innerHTML = '';
            for(let i=0; i<3; i++) container.innerHTML += `<i class="fas fa-heart text-xl ${i<hearts ? 'text-red-500' : 'text-gray-600'}"></i>`;
        }

        function loadLevel(lvl) {
            currentLevel = lvl;
            availableQuestions = questions.filter(q => q.level === lvl).sort(() => Math.random() - 0.5);
            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (availableQuestions.length === 0) {
                if (currentLevel < 5) {
                    currentLevel++;
                    loadLevel(currentLevel);
                } else {
                    endGame(true);
                }
                return;
            }
            currentQuestion = availableQuestions.pop();
            secondChanceActive = true; 
            renderQuestion(currentQuestion);
        }

        function renderQuestion(q) {
            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('options-grid').innerHTML = '';
            document.getElementById('sage-area').classList.add('hidden');
            document.getElementById('sage-btn').disabled = false;
            document.getElementById('sage-btn').innerHTML = '<i class="fas fa-magic"></i> Ask the Sage';
            
            document.getElementById('question-tag').innerText = `Level ${currentLevel}: ${q.category}`;
            document.getElementById('question-text').innerHTML = q.text;

            const grid = document.getElementById('options-grid');
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "option-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-xl border-b-4 border-gray-900 text-lg w-full";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(index, btn);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(index, btnElement) {
            const isCorrect = index === currentQuestion.correctIndex;
            
            if (!isCorrect && secondChanceActive) {
                secondChanceActive = false; 
                btnElement.disabled = true;
                btnElement.classList.replace('bg-gray-700', 'bg-gray-800');
                btnElement.classList.add('opacity-50', 'cursor-not-allowed');
                btnElement.innerText = "Try Again!";
                
                const sageArea = document.getElementById('sage-area');
                sageArea.classList.remove('hidden');
                document.getElementById('sage-text').innerHTML = "Not quite! Look closer at the order or units. You have <b>one more try</b>!";
                
                const card = document.getElementById('question-card');
                card.classList.add('shake-element');
                setTimeout(() => card.classList.remove('shake-element'), 500);
                return; 
            }

            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => b.disabled = true);
            
            detailedLog.push({ question: currentQuestion.text, category: currentQuestion.category, isCorrect, studentAnswer: currentQuestion.options[index] });

            document.getElementById('feedback-area').classList.remove('hidden');
            document.getElementById('explanation-text').innerHTML = currentQuestion.explanation;

            const msg = document.getElementById('feedback-message');
            if (isCorrect) {
                const points = secondChanceActive ? 100 : 50;
                score += points * currentLevel;
                msg.innerText = secondChanceActive ? "Correct!" : "Correct! (+Half Points)";
                msg.className = "p-4 rounded-lg mb-4 font-bold text-center bg-green-900 text-green-200 border border-green-500";
                btns[index].classList.replace('bg-gray-700', 'bg-green-600');
                if(secondChanceActive === false) btns[index].innerText += " (2nd Try)"; 
                fireConfetti();
            } else {
                hearts--;
                msg.innerText = "Incorrect.";
                msg.className = "p-4 rounded-lg mb-4 font-bold text-center bg-red-900 text-red-200 border border-red-500";
                btns[index].classList.replace('bg-gray-700', 'bg-red-600');
                btns[currentQuestion.correctIndex].classList.replace('bg-gray-700', 'bg-green-600');
            }
            updateHUD();
            
            if (hearts <= 0) {
                setTimeout(showShop, 1500);
            }
        }

        function showShop() {
            document.getElementById('shop-modal').classList.remove('hidden');
            document.getElementById('shop-score-display').innerText = score;
            const buyBtn = document.getElementById('buy-btn');
            
            if (score >= 500) {
                buyBtn.disabled = false;
                buyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                buyBtn.disabled = true;
                buyBtn.classList.add('opacity-50', 'cursor-not-allowed');
                buyBtn.innerHTML = `<span><i class="fas fa-lock mr-2"></i> Not enough points</span><span>Need 500</span>`;
            }
        }

        function buyContinue() {
            if (score >= 500) {
                score -= 500;
                hearts = 3; 
                updateHUD();
                document.getElementById('shop-modal').classList.add('hidden');
                loadNextQuestion(); 
            }
        }

        function giveUp() {
            document.getElementById('shop-modal').classList.add('hidden');
            endGame(false);
        }

        function nextQuestion() { if (hearts > 0) loadNextQuestion(); }

        async function endGame(victory) {
            clearInterval(timerInterval);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-modal').classList.remove('hidden');
            
            document.getElementById('end-title').innerText = victory ? "VICTORY!" : "GAME OVER";
            document.getElementById('end-icon').innerHTML = victory ? '<i class="fas fa-trophy text-yellow-400"></i>' : '<i class="fas fa-heart-broken text-red-500"></i>';
            document.getElementById('end-message').innerText = victory ? "You mastered the Syllabus!" : "Keep practicing!";
            document.getElementById('final-score').innerText = score;

            const saveMsg = document.getElementById('save-status');
            const btnContainer = document.getElementById('submission-buttons');
            btnContainer.innerHTML = ''; 
            
            let saveSuccess = false;
            
            // 1. Firebase Save (Now explicitly using provided keys)
            if (window.saveStudentResult && window.firebaseState.isOnline) {
                saveMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                const success = await window.saveStudentResult(currentStudentName, score, currentLevel, detailedLog);
                if (success) {
                    saveMsg.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> Saved to Class DB';
                    saveSuccess = true;
                    // Get Stats
                    if (window.listenToResults) {
                        window.listenToResults((results) => {
                            const stats = processLeaderboard(results);
                            const myStat = stats.find(s => s.name.toLowerCase() === currentStudentName.toLowerCase());
                            if(myStat) {
                                document.getElementById('end-attempts').innerText = myStat.attempts;
                                const rank = stats.indexOf(myStat) + 1;
                                document.getElementById('end-rank').innerText = `#${rank}`;
                            }
                        });
                    }
                } else {
                    saveMsg.innerHTML = '<i class="fas fa-exclamation-circle text-yellow-500"></i> Offline - Result Local Only';
                    document.getElementById('end-attempts').innerText = "Offline";
                    document.getElementById('end-rank').innerText = "-";
                }
            } else {
                saveMsg.innerHTML = '<span class="text-gray-500">Mode: Offline / Local File</span>';
            }
            
            // 2. Auto-Submit Google Form (Silent)
            const conf = window.teacherConfig;
            if (conf.formAction && conf.entryName) {
                try {
                    // Populate hidden form
                    document.getElementById('form-name').name = conf.entryName;
                    document.getElementById('form-name').value = currentStudentName;
                    
                    document.getElementById('form-score').name = conf.entryScore;
                    document.getElementById('form-score').value = score;
                    
                    document.getElementById('form-level').name = conf.entryLevel;
                    document.getElementById('form-level').value = currentLevel;
                    
                    document.getElementById('google-form').action = conf.formAction;
                    
                    // Submit!
                    document.getElementById('google-form').submit();
                    
                    const autoMsg = document.createElement('div');
                    autoMsg.className = "text-green-400 text-xs mt-2";
                    autoMsg.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Sent to Teacher';
                    saveMsg.appendChild(autoMsg);
                    
                } catch(e) {
                    console.error("Auto-submit failed", e);
                    // Fallback button if auto-fail
                    const fallbackBtn = document.createElement('a');
                    fallbackBtn.href = conf.formAction.replace("formResponse", "viewform");
                    fallbackBtn.target = "_blank";
                    fallbackBtn.className = "block w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2";
                    fallbackBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Manual Submit (Backup)';
                    btnContainer.appendChild(fallbackBtn);
                }
            }

            // 3. Email Button (Backup)
            if (conf.email && conf.email.length > 3) {
                const subject = `Ratio Rescue Result: ${currentStudentName}`;
                const body = `Student: ${currentStudentName}%0D%0AScore: ${score}%0D%0AMax Level: ${currentLevel}%0D%0A%0D%0A(Generated by Ratio Rescue)`;
                const mailto = `mailto:${conf.email}?subject=${encodeURIComponent(subject)}&body=${body}`;
                const emailBtn = document.createElement('a');
                emailBtn.href = mailto;
                emailBtn.className = "block w-full bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 mt-3";
                emailBtn.innerHTML = '<i class="fas fa-envelope"></i> Email Result (Backup)';
                btnContainer.appendChild(emailBtn);
            }
        }
        
        function showLeaderboard() {
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-purple-500"></i><br>Summoning Records...</td></tr>';
            
            if (window.listenToResults) {
                window.listenToResults((results) => {
                    if(!results || results.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No records found. Be the first!</td></tr>';
                        return;
                    }
                    const leaderboardData = processLeaderboard(results);
                    renderLeaderboard(leaderboardData);
                });
            } else {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Offline. Connect to view.</td></tr>';
            }
        }
        
        function processLeaderboard(results) {
            const stats = {};
            results.forEach(r => {
                const name = r.studentName.trim();
                if(!stats[name]) {
                    stats[name] = { name: name, bestScore: 0, attempts: 0 };
                }
                stats[name].attempts++;
                if(r.score > stats[name].bestScore) stats[name].bestScore = r.score;
            });
            return Object.values(stats).sort((a,b) => b.bestScore - a.bestScore);
        }
        
        function renderLeaderboard(data) {
             const tbody = document.getElementById('leaderboard-body');
             tbody.innerHTML = '';
             data.forEach((entry, index) => {
                 const tr = document.createElement('tr');
                 let rankClass = '';
                 let rankIcon = '';
                 if(index === 0) { rankClass = 'gold-row'; rankIcon = '<i class="fas fa-crown text-yellow-500"></i>'; }
                 else if(index === 1) { rankClass = 'silver-row'; rankIcon = '<i class="fas fa-medal text-gray-400"></i>'; }
                 else if(index === 2) { rankClass = 'bronze-row'; rankIcon = '<i class="fas fa-medal text-yellow-700"></i>'; }
                 tr.className = rankClass;
                 tr.innerHTML = `<td class="font-bold">${rankIcon || (index + 1)}</td><td class="font-bold text-white">${entry.name}</td><td class="font-mono text-green-400">${entry.bestScore}</td><td class="text-gray-400 text-center">${entry.attempts}</td>`;
                 tbody.appendChild(tr);
             });
        }
        
        function closeLeaderboard() { document.getElementById('leaderboard-modal').classList.add('hidden'); }

        function openTeacherPortal() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('teacher-portal').classList.remove('hidden');
            loadResults();
        }

        function closeTeacherPortal() {
            document.getElementById('teacher-portal').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

        function showInstructions() { document.getElementById('instructions-modal').classList.remove('hidden'); }

        function loadResults() {
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            if (window.listenToResults) {
                window.listenToResults((results) => {
                    tbody.innerHTML = '';
                    if (!results || results.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No data or Offline.</td></tr>'; return; }
                    results.forEach((r, i) => {
                        const date = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleDateString() : 'Just now';
                        const tr = document.createElement('tr');
                        
                        tr.dataset.studentInfo = JSON.stringify(r);
                        
                        tr.innerHTML = `
                            <td class="font-bold text-white">${r.studentName}</td>
                            <td class="text-green-400 font-mono">${r.score}</td>
                            <td>Lvl ${r.maxLevelReached}</td>
                            <td class="text-gray-400 text-xs">${date}</td>
                            <td><button class="ai-coach-btn bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded" data-index="${i}"><i class="fas fa-robot"></i> AI Coach</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    document.querySelectorAll('.ai-coach-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const tr = e.target.closest('tr');
                            const data = JSON.parse(tr.dataset.studentInfo);
                            analyzeStudent(data);
                        });
                    });
                });
            }
        }

        async function analyzeStudent(studentData) {
            const modal = document.getElementById('analysis-modal');
            const content = document.getElementById('analysis-content');
            document.getElementById('analysis-student-name').innerText = `Analysis: ${studentData.studentName}`;
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="flex flex-col items-center justify-center py-8"><i class="fas fa-spinner fa-spin text-4xl text-purple-500 mb-4"></i><p>Generating personalized report...</p></div>';
            
            const mistakes = studentData.details.filter(d => !d.isCorrect);
            const prompt = `Act as a supportive Singapore Math Teacher analyzing a student's performance. 
            Student: ${studentData.studentName}. Score: ${studentData.score}. Level: ${studentData.maxLevelReached}.
            Mistakes: ${JSON.stringify(mistakes.map(m => ({ category: m.category, question: m.question })))}
            
            Provide a performance review with these 3 sections in valid HTML:
            <h3>1. Weakness Identification</h3>
            <p>Briefly explain the main concept they struggled with based on the mistakes.</p>
            <h3>2. Concept Review</h3>
            <p>Explain the correct method simply (e.g. "Remember to make units the same").</p>
            <h3>3. Encouragement</h3>
            <p>A positive closing remark.</p>
            
            IMPORTANT: Do not use LaTeX formatting (like $30\text{cm}$). Use plain text (e.g. "30 cm") for units. Do not use Markdown (no **bold** or # headings), use HTML tags <b>, <strong>, <ul>, <li> instead.`;

            const result = await callGemini(prompt);
            content.innerHTML = result || "<p class='text-red-400'>Analysis failed. Please try again.</p>";
        }

        function closeAnalysis() { document.getElementById('analysis-modal').classList.add('hidden'); }

        async function callGemini(promptText) {
            // Check for execution environment key first, fallback to none if not present
            const key = typeof apiKey !== 'undefined' ? apiKey : '';
            if(!key) return "<i>AI Config Error (No Key Provided)</i>";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] }) });
                if (!response.ok) throw new Error(response.statusText);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { 
                console.error("Gemini Error:", e);
                return null; 
            }
        }

        async function askSage() {
             const btn = document.getElementById('sage-btn');
             btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
             const prompt = `Help a P6 student with this math question (Hint only, no answer): "${currentQuestion.text}". Options: ${currentQuestion.options.join(', ')}.`;
             const text = await callGemini(prompt);
             document.getElementById('sage-area').classList.remove('hidden');
             document.getElementById('sage-text').innerText = text || "The Sage is silent (Connection Error)...";
             btn.innerHTML = '<i class="fas fa-check"></i> Sage Spoken';
        }

        async function generateSimilarQuestion() {
            const loading = document.getElementById('loading-overlay'); loading.classList.remove('hidden');
            const prompt = `Create a unique Singapore Primary 6 Math question about "${currentQuestion.category}". Similar difficulty/logic to: "${currentQuestion.text}". Return valid JSON: { "text": "...", "options": ["..."], "correctIndex": 0, "explanation": "..." }`;
            const result = await callGemini(prompt);
            loading.classList.add('hidden');
            if (result) {
                try {
                    const newQ = JSON.parse(result.match(/\{[\s\S]*\}/)[0]);
                    newQ.level = currentLevel; newQ.category = `${currentQuestion.category} (AI)`;
                    currentQuestion = newQ; renderQuestion(newQ);
                } catch (e) { alert("Sage Error."); }
            } else { alert("Connection Error."); }
        }

        // FX
        const canvas = document.getElementById("confetti-canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        function fireConfetti() { for(let i=0; i<50; i++) particles.push({x: window.innerWidth/2, y: window.innerHeight/2, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, color:`hsl(${Math.random()*360},100%,50%)`, life:100}); requestAnimationFrame(updateConfetti); }
        function updateConfetti() { ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.life--; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); if(p.life<=0) particles.splice(i,1); }); if(particles.length>0) requestAnimationFrame(updateConfetti); }
        window.addEventListener('resize', ()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });
    </script>
</body>
</html>
